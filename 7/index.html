<!DOCTYPE html>
<html>
<head>
    <title>坦克大战</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=340, user-scalable=0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="jquery.min.js"></script>
    <script src="hammer.min.js"></script>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            font-family: monospace;
            font-size: 16px;
            line-height: 1.5;
        }
        .container {
            width: 320px;
            margin: auto;
        }
        .group {
            padding: 4px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            margin-top: 10px;
        }
        .dot {
            list-style-type: none;
            width: 200px;
        }
        .dot::after {
            content: '';
            display: block;
            clear: both;
        }
        .dot>li {
            float: left;
            width: 20px;
            height: 16px;
            position: relative;
        }
        .dot>li::before {
            content: '';
            display: block;
            width: 8px;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            margin: 5px 6px;
            position: absolute;
            z-index: 1;
        }
        .dot>li::after {
            content: '';
            display: block;
            width: 14px;
            height: 10px;
            border: rgba(0, 0, 0, 0.1) solid 2px;
            margin: 1px;
        }
        .dot>li.active::before {
            background: #000;
        }
        .dot>li.active::after {
            border-color: #000;
        }
        .hidden {
            opacity: 0;
        }
        .button {
            height: 80px;
            width: 50%;
            float: left;
            position: relative;
        }
        .button div {
            border: rgba(0, 0, 0, 0.1) solid 2px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -24px;
            margin-left: -24px;
            padding: 4px;
        }
        .button.active div {
            border-color: #000;
        }
        .button div::before {
            display: block;
            background: #000;
            height: 100%;
            border-radius: 50%;
            content: '';
        }
        #game-over, #pause {
            color: rgba(0, 0, 0, 0.1); 
        }
        #game-over.active, #pause.active {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="margin-top: 10px;">
            <h3 style="text-align: center;">坦克大战</h3>
            <div>zy_cwind@weixin</div>
        </div>
        <div class="group" style="position: relative;">
            <ul id="dc" class="dot"></ul>
            <div style="width: 108px; position:absolute; right: 4px; top: 0; height: 100%; text-align: center;">
                <div id="total-point" style="margin-top: 4px; font-size: 18px;"></div>
                <div style="font-size: 14px; color: rgba(0, 0, 0, 0.1);">HI-<span style="font-size: 14px; color: #000;">SCORE</span>&nbsp;♬</div>
                <div style="margin-top: 8px;">
                    <ul id="life" class="dot" style="width: 80px; margin: auto;"><li></li><li></li><li></li><li></li><li class="hidden"></li><li></li><li></li><li class="hidden"></li><li class="hidden"></li><li></li><li></li><li class="hidden"></li><li class="hidden"></li><li></li><li></li><li class="hidden"></li></ul>
                </div>
                <div style="margin-top: 8px;">
                    <div style="font-size: 18px; width: 50%; float: left;"><span style="font-size: 18px; color: rgba(0, 0, 0, 0.1);">1</span>0<div style="font-size: 14px;">SPEED</div></div>
                    <div style="font-size: 18px; width: 50%; float: left;"><span style="font-size: 18px; color: rgba(0, 0, 0, 0.1);">1</span>0<div style="font-size: 14px;">LEVEL</div></div>
                    <div style="clear: both;"></div>
                </div>
                <div style="margin-top: 4px;"><img src="images/1.png" style="width: 100%;" /></div>
                <div id="pause" style="margin-top: 4px; font-size: 14px;">PAUSE</div>
                <div id="game-over" style="margin-top: 4px;">GAME OVER</div>
            </div>
        </div>
        <div class="group">
            <div id="pad" class="button"><div></div></div>
            <div id="fire-button" class="button" style="text-align: center;"><div></div></div>
            <div style="clear: both;"></div>
        </div>
        <div style="margin-top: 10px;">
            <div style="float:right;">©版权所有,转载请注明出处</div>
            <div style="clear:both;"></div>
        </div>
    </div>
    <script type="text/javascript">
        var CONFIG = {
            w: 10,
            h: 20,
            speed: 100
        };

        var Timer = function (ticks, callback) {
            this.counter = this.ticks = ticks;
            this.callback = callback;
            Timer.queue.push(this);
        };

        Timer.prototype.tick = function () {
            if (!--this.counter) {
                this.counter = this.ticks;
                this.callback();
            }
        }

        Timer.prototype.stop = function () {
            for (var i = 0; i < Timer.queue.length; i++) {
                if (this == Timer.queue[i]) {
                    Timer.queue.splice(i, 1);
                    break;
                }
            }
        };

        Timer.step = function () {
            var queue = Timer.queue.concat();
            for (var i = 0; i < queue.length; i++) {
                queue[i].tick();
            }
        };

        Timer.queue = [];

        var Sprite = function (parent, x, y, w, h) {
            this.parent = parent;
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.children = [];
            this.bitmapData = '0'.repeat(this.w * this.h);
        };

        Sprite.prototype.draw = function (parentBitmapData, fullFill = false) {
            var bitmapData;
            if (fullFill) {
                bitmapData = '1'.repeat(this.bitmapData.length);
            } else {
                bitmapData = this.bitmapData;
                $.each(this.children, function (i, child) {
                    bitmapData = child.draw(bitmapData);
                });
            }
            var splitted = parentBitmapData.split('');
            for (var i = 0; i < this.h; i++) {
                for (var j = 0; j < this.w; j++) {
                    if (bitmapData[i * this.w + j] == '1') {
                        splitted[(this.y + i) * this.parent.w + this.x + j] = '1';
                    }
                }
            }
            return splitted.join('');
        };

        Sprite.prototype.hit = function () {
            /**
             * 碰撞检测区域为矩形
             *
             *
             */
            var bitmapData = this.draw('0'.repeat(this.parent.bitmapData.length), true);
            for (var i = 0; i < this.parent.children.length; i++) {
                if (this != this.parent.children[i]) {
                    if (this.parent.children[i].draw(bitmapData, true).replace(/0/g, '') != bitmapData.replace(/0/g, '') + this.parent.children[i].draw('0'.repeat(this.parent.bitmapData.length), true).replace(/0/g, '')) {
                        return this.parent.children[i];
                    }
                }
            }
        };

        Sprite.prototype.removeChild = function (child) {
            for (var i = 0; i < this.children.length; i++) {
                if (child == this.children[i]) {
                    this.children.splice(i, 1);
                    break;
                }
            }
        };

        Sprite.prototype.overflow = function () {
            return this.x < 0 || this.y < 0 || this.x + this.w > this.parent.w || this.y + this.h > this.parent.h;
        };

        Sprite.prototype.dispose = function () {
            $.each(this.children, function (i, child) {
                child.dispose();
            });
        }

        var Bullet = function (parent, x, y, direction) {
            Sprite.call(this, parent, x, y, 1, 1);
            this.direction = direction;
            this.bitmapData = '1';
            this.timer = new Timer(1, this.move.bind(this));
        };

        Bullet.prototype = new Sprite();

        Bullet.prototype.move = function () {
            var x = this.x;
            var y = this.y;
            var target;
            switch (this.direction) {
            case 0: this.x += 1; break;
            case 1: this.x -= 1; break;
            case 2: this.y += 1; break;
            case 3: this.y -= 1; break;
            }
            if (this.overflow()) {
                this.dispose();
                this.parent.removeChild(this);
            } else if (target = this.hit()) {
                Bullet.hitEventHandler(this, target);
            }
        };

        Bullet.prototype.dispose = function () {
            Sprite.prototype.dispose.call(this);
            this.timer.stop();
        };

        Bullet.hitEventHandler = function (bullet, target) {
        };

        var Tank = function (parent, x, y, direction) {
            Sprite.call(this, parent, x, y, 3, 3);
            this.direction = direction;
            this.bitmapData = Tank.data[this.direction];
        };

        Tank.prototype = new Sprite();

        Tank.prototype.fire = function () {
            var position = [[3, 1], [-1, 1], [1, 3], [1, -1]][this.direction];
            var bullet = new Bullet(this.parent, this.x + position[0], this.y + position[1], this.direction);
            if (!bullet.overflow()) {
                this.parent.children.push(bullet);
                return bullet;
            }
            bullet.dispose();
        };

        Tank.prototype.setDirection = function (direction) {
            this.direction = direction;
            this.bitmapData = Tank.data[direction];
        };

        Tank.prototype.go = function (action) {
            var x = this.x;
            var y = this.y;
            var direction = this.direction;
            switch (action) {
            case 0: this.setDirection(0); break;
            case 1: this.setDirection(1); break;
            case 2: this.setDirection(2); break;
            case 3: this.setDirection(3); break;
            case 4: switch (this.direction)
            {
                case 0: this.x += 1; break; 
                case 1: this.x -= 1; break;
                case 2: this.y += 1; break;
                case 3: this.y -= 1; break;
            }
                break;
            case 5: this.fire(); return;
            }
            if (this.overflow() || this.hit()) {
                this.x = x;
                this.y = y;
                this.setDirection(direction);
            }
        };

        Tank.data = ['110011110', '011110011', '101111010', '010111101'];

        var Enemy = function (parent, x, y) {
            Tank.call(this, parent, x, y, parseInt(Math.random() * 4));
            this.timer = new Timer(4, this.ai.bind(this));
            Enemy.count++;
        };

        Enemy.prototype = new Tank();

        Enemy.prototype.ai = function () {
            this.go([0, 1 , 2 , 3 , 4 , 4 , 4 , 4 , 5 , 5 , 5 , 5][parseInt(Math.random() * 12)]);
        };

        Enemy.prototype.dispose = function () {
            this.timer.stop();
            Enemy.count--;
        };

        Enemy.count = 0;

        var Gamer = function (parent) {
            Tank.call(this, parent, parseInt((parent.w - 3) / 2), parseInt((parent.h - 3) / 2), 3);
            this.timer = new Timer(1, this.mark.bind(this));
            this.alive = true;
        };

        Gamer.prototype = new Tank();

        Gamer.prototype.mark = function () {
            if (this.alive) {
                var bitmapData = this.bitmapData.split('');
                bitmapData[4] = bitmapData[4] == '0' ? '1' : '0';
                this.bitmapData = bitmapData.join('');
            } else {
                this.bitmapData = this.bitmapData == Gamer.data[0] ? Gamer.data[1] : Gamer.data[0];
            }
        };

        Gamer.prototype.fire = function () {
            if (this.alive) {
                var bullet = Tank.prototype.fire.call(this);
                if (bullet) {
                    bullet.isFromGamer = true;
                }
            }
        }

        Gamer.prototype.dead = function () {
            delete this.alive;
            this.w = 4;
            this.h = 4;
            this.x = this.x + this.w > this.parent.w ? this.parent.w - this.w : this.x;
            this.y = this.y + this.h > this.parent.h ? this.parent.h - this.h : this.y;
            this.bitmapData = Gamer.data[0];
            this.timer.counter = this.timer.ticks = 4;
        };

        Gamer.prototype.dispose = function () {
            this.timer.stop();
        };

        Gamer.data = ['1001011001101001', '0'.repeat(16)];

        var DC = function () {
            Sprite.call(this, {
                w: CONFIG.w
            }, 0, 0, CONFIG.w, CONFIG.h);
            $('#dc').html('<li></li>'.repeat(this.bitmapData.length));
            this.life = 4;
            this.totalPoint = 0;
            Bullet.hitEventHandler = this.hitEventHandler.bind(this), new Pad($('#pad').get(0), this.onPressListener.bind(this)), new Button($('#fire-button').get(0), this.onPressListener.bind(this));
            this.bootup();
        };

        DC.prototype = new Sprite();

        DC.prototype.wear = function () {
            var bitmapData = this.draw(this.bitmapData);
            var $dc = $('#dc>li');
            var $life = $('#life>li');
            var totalPoint = this.totalPoint.toString();
            $dc.removeClass('active');
            for (var i = 0; i < bitmapData.length; i++) {
                if (bitmapData[i] == '1') {
                    $dc.eq(i).addClass('active');
                }
            }
            $life.removeClass('active');
            for (var i = 0; i < this.life; i++) {
                $life.eq(i).addClass('active');
            }
            $('#total-point').text(totalPoint.length < 6 ? '0'.repeat(6 - totalPoint.length) + totalPoint : totalPoint.substr(totalPoint.length - 6, 6));
            if (this.gameOver) {
                $('#game-over').addClass('active');
            }
        };

        DC.prototype.bootup = function () {
            this.gamer = new Gamer(this);
            this.children.push(this.gamer);
            this.timer = new Timer(4, this.ai.bind(this));
        };

        DC.prototype.ai = function () {
            if (Enemy.count < 4) {
                var enemy = new Enemy(this, 0, 0);
                var position = [[0, 0], [0, this.h - enemy.h], [this.w - enemy.w, 0], [this.w - enemy.w, this.h - enemy.h]][parseInt(Math.random() * 4)];
                enemy.x = position[0];
                enemy.y = position[1];
                if (!enemy.hit()) {
                    this.children.push(enemy);
                } else {
                    enemy.dispose();
                }
            }
        };

        DC.prototype.hitEventHandler = function (bullet, target) {
            bullet.dispose();
            this.removeChild(bullet);
            if (target instanceof Bullet) {
                target.dispose();
                this.removeChild(target);
            } else if (target instanceof Gamer) {
                target.dead();
                this.timer.stop();
                $.each(this.children, function (i, child) {
                    if (child instanceof Enemy || child instanceof Bullet) {
                        child.timer.stop();
                    }
                });
                if (!--this.life) {
                    this.gameOver = true;
                } else {
                    this.timer = new Timer(32, function () {
                        this.timer.stop();
                        this.dispose();
                        this.children.length = 0;
                        this.bootup();
                    }.bind(this));
                }
            } else if (target instanceof Enemy) {
                if (bullet.isFromGamer) {
                    target.dispose();
                    this.removeChild(target);
                    this.totalPoint += 500;
                }
            }
        };

        DC.prototype.onPressListener = function (action) {
            if (this.gamer.alive) {
                if (action <= 3 && this.gamer.direction == action) {
                    action = 4;
                }
                this.gamer.go(action);
            }
        };

        var Pad = function (el, onPressListener) {
            var mc = new Hammer.Manager(el);
            var $el = $(el);
            var offset = $el.offset();
            mc.add(new Hammer.Pan({threshold: 0, pointers: 1}));
            mc.on("panstart panmove panend", this.onPan.bind(this));
            this.el = el;
            this.onPressListener = onPressListener;
            this.timer = new Timer(4, this.dispatch.bind(this));
            this.o = $el.children().eq(0).offset();
            this.o = {left: this.o.left - offset.left, top: this.o.top - offset.top};
        };

        Pad.prototype.onPan = function (event) {
            var $el = $(this.el);
            var $stick = $el.children().eq(0);
            var offset = {left: this.o.left, top: this.o.top};
            if (event.type != 'panend') {
                var w = $el.width() - $stick.outerWidth(), h = $el.height() - $stick.outerHeight();
                offset.left += event.deltaX, offset.top += event.deltaY;
                offset.left = offset.left < 0 ? 0 : offset.left, offset.top = offset.top < 0 ? 0 : offset.top;
                offset.left = offset.left > w ? w : offset.left, offset.top = offset.top > h ? h : offset.top;
                this.direction = (function (a) {
                    var oX = $el.width() / 2, oY = $el.height() / 2;
                    var limit = [];
                    $.each([[-oX, -oY], [oX, -oY], [oX, oY], [-oX, oY]], function (i, offset) {
                        limit.push(Math.atan2(offset[1], offset[0]));
                    });
                    if (limit[0] <= a && a < limit[1]) return 3; else if (limit[1] <= a && a < limit[2]) return 0; else if (limit[2] <= a && a < limit[3]) return 2; else return 1;
                })(Math.atan2(event.deltaY, event.deltaX));
            } else {
                delete this.direction;
            }
            $stick.css('left', offset.left), $stick.css('top', offset.top), $stick.css('margin', 0);
        };

        Pad.prototype.dispatch = function () {
            if (this.direction != undefined) {
                this.onPressListener(this.direction);
            }
        };

        var Button = function (el, onPressListener) {
            var mc = new Hammer.Manager(el);
            mc.add(new Hammer.Press({time: 1}));
            mc.on("press pressup", function (event) {
                if (event.type == 'press') {
                    $(el).addClass('active');
                    this.fire = 0;
                    this.timer.counter = this.timer.ticks;
                    this.dispatch();
                } else {
                    $(el).removeClass('active');
                    delete this.fire;
                }
            }.bind(this));
            this.onPressListener = onPressListener;
            this.timer = new Timer(10, this.dispatch.bind(this));
        };

        Button.prototype.dispatch = function () {
            if (this.fire != undefined) {
                this.onPressListener(5);
            }
        };

        $(function () {
            var dc = new DC();
            var loop = function () {
                dc.wear();
                Timer.step();
                setTimeout(loop, CONFIG.speed);
            };
            setTimeout(loop , CONFIG.speed);
            loop();
        });
    </script>
</body>
</html>