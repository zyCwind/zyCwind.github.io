<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=371, user-scalable=0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <style type="text/css">
        *{margin:0;padding:0;-webkit-tap-highlight-color:rgba(0,0,0,0);outline:none;}#cords li{position:absolute;width:14px;height:14px;}#y,#b,#g,#r{float:left;width:80px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;background-color:bisque;text-align:center;line-height:22px;font-size:14px;}#keyboard li{margin:2px;border:solid 1px burlywood;background-color:bisque;width:52px;height:32px;font-size:14px;line-height:32px;text-align:center;float:left;}#room li{width:40px;height:40px;background:#fff;border:bisque solid 1px;float:left;margin:2px;font-size:14px;line-height:42px;text-align:center;}#leave::before{content:"\2716";}#bg,#craps,.y0,y1,.b0,.b1,.g0,.g1,.r0,.r1{background:url(images/1.png) no-repeat;}#bg{width:355px;height:355px;}#bg.y{background-position:0 0;}#bg.b{background-position:-355px 0;}#bg.g{background-position:0 -355px;}#bg.r{background-position:-355px -355px;}#craps{width:60px;height:60px;position:absolute;z-index:17;margin-left:-30px;margin-top:-30px;}#craps.y{left:260px;top:280px;}#craps.b{left:95px;top:280px;}#craps.g{left:95px;top:75px;}#craps.r{left:260px;top:75px;}#craps[data-i="0"]{background-position:0 -770px;}#craps[data-i="1"]{background-position:0 -830px;}#craps[data-i="2"]{background-position:0 -890px;}#craps[data-i="3"]{background-position:0 -950px;}#craps[data-i="4"]{background-position:0 -1010px;}#craps[data-i="5"]{background-position:0 -710px;}.y0,y1,.b0,.b1,.g0,.g1,.r0,.r1{width:20px;height:20px;}.y0{background-position:-460px -710px;}.y1{background-position:-480px -710px;}.b0{background-position:-420px -710px;}.b1{background-position:-440px -710px;}.g0{background-position:-540px -710px;}.g1{background-position:-560px -710px;}.r0{background-position:-500px -710px;}.r1{background-position:-520px -710px;}#ch .s::before {content: '\2714'}#ch{bottom: -32px;}#ch.on{bottom: 0;}
    </style>
    <script src="js/jquery.min.js"></script><script src="js/stomp.min.js"></script>
</head>
<body>
    <div style="padding: 4px; width: 355px; margin: auto;">
        <div style="margin-top: 10px;">
            <h3 style="text-align: center; display: none;">飞行棋</h3>
            <div>zy_cwind@weixin</div>
        </div>
        <div style="position: relative; margin-top: 10px; width: 355px; height: 451px;">
            <div id="token" style="height: 100%; width: 100%; background-color: burlywood;">
                <div style="padding-top: 48px;">
                    <div style="text-align: center; margin: 10px; font-size: 14px;">房间号:</div>
                    <ul id="room" style="list-style-type: none; width: 184px; margin: auto;">
                        <li></li><li></li><li></li><li></li>
                    </ul>
                </div>
                <div style="position: absolute; bottom: 2px;">
                    <div style="clear: both;"></div>
                    <ul id="keyboard" style="list-style-type: none; width: 351px; padding-left: 3px;">
                        <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li><</li>
                    </ul>
                </div>
            </div>
            <div id="m" style="display: none; background-color: bisque;">
                <div style="padding: 5px; background-color: bisque; height: 22px; position: relative;">
                    <div id="q" style="font-size: 14px; line-height: 22px; width: 313px; height: 22px; text-align: center; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;"></div>
                    <div id="leave" style="position: absolute; top: 0; right: 0; width: 32px; height: 32px; font-size: 14px; line-height: 32px; text-align: center; color: #fff; background-color: indianred;"></div>
                </div>
                <div style="padding: 5px; background-color: burlywood; height: 22px;">
                    <div id="g"></div><div id="r" style="float: right;"></div><div style="clear: both;"></div>
                </div>
                <div id="content" style="position: relative; width: 355px; height: 355px; overflow: hidden;">
                    <div id="craps" class="r" data-i="0" style="display: none;"></div>
                    <div id="bg">
                        <ul id="cords" style="list-style-type: none;"><li style="left: 27px; top: 338px;" /><li style="left: 3px; top: 338px;" /><li style="left: 3px; top: 314px;" /><li style="left: 27px; top: 314px;" /><li style="left: 338px; top: 338px;" /><li style="left: 314px; top: 338px;" /><li style="left: 314px; top: 314px;" /><li style="left: 338px; top: 314px;" /><li style="left: 338px; top: 27px;" /><li style="left: 314px; top: 27px;" /><li style="left: 314px; top: 3px;" /><li style="left: 338px; top: 3px;" /><li style="left: 27px; top: 27px;" /><li style="left: 3px; top: 27px;" /><li style="left: 3px; top: 3px;" /><li style="left: 27px; top: 3px;" /><li style="left: 227px; top: 339px;" /><li style="left: 339px; top: 114px;" /><li style="left: 114px; top: 2px;" /><li style="left: 2px; top: 227px;" /><li style="left: 227px; top: 29px;" /><li style="left: 149px; top: 291px;" /><li style="left: 305px; top: 206px;" /><li style="left: 72px; top: 156px;" /><li style="left: 29px; top: 227px;" /><li style="left: 291px; top: 149px;" /><li style="left: 206px; top: 305px;" /><li style="left: 156px; top: 72px;" /><li style="left: 277px; top: 277px;" /><li style="left: 93px; top: 36px;" /><li style="left: 36px; top: 93px;" /><li style="left: 291px; top: 79px;" /><li style="left: 79px; top: 291px;" /><li style="left: 255px; top: 255px;" /><li style="left: 241px; top: 241px;" /><li style="left: 227px; top: 227px;" /><li style="left: 213px; top: 213px;" /><li style="left: 199px; top: 199px;" /><li style="left: 185px; top: 185px;" /><li style="left: 185px; top: 72px;" /><li style="left: 135px; top: 305px;" /><li style="left: 312px; top: 227px;" /><li style="left: 50px; top: 149px;" /><li style="left: 36px; top: 206px;" /><li style="left: 270px; top: 156px;" /><li style="left: 192px; top: 291px;" /><li style="left: 114px; top: 29px;" /><li style="left: 263px; top: 291px;" /><li style="left: 50px; top: 79px;" /><li style="left: 248px; top: 36px;" /><li style="left: 305px; top: 93px;" /><li style="left: 65px; top: 277px;" /><li style="left: 156px; top: 185px;" /><li style="left: 142px; top: 199px;" /><li style="left: 128px; top: 213px;" /><li style="left: 114px; top: 227px;" /><li style="left: 100px; top: 241px;" /><li style="left: 86px; top: 255px;" /><li style="left: 192px; top: 50px;" /><li style="left: 114px; top: 312px;" /><li style="left: 270px; top: 185px;" /><li style="left: 36px; top: 135px;" /><li style="left: 50px; top: 192px;" /><li style="left: 312px; top: 114px;" /><li style="left: 185px; top: 270px;" /><li style="left: 135px; top: 36px;" /><li style="left: 305px; top: 248px;" /><li style="left: 248px; top: 305px;" /><li style="left: 65px; top: 65px;" /><li style="left: 262px; top: 50px;" /><li style="left: 50px; top: 262px;" /><li style="left: 156px; top: 156px;" /><li style="left: 142px; top: 142px;" /><li style="left: 128px; top: 128px;" /><li style="left: 114px; top: 114px;" /><li style="left: 100px; top: 100px;" /><li style="left: 86px; top: 86px;" /><li style="left: 206px; top: 36px;" /><li style="left: 156px; top: 270px;" /><li style="left: 291px; top: 192px;" /><li style="left: 29px; top: 114px;" /><li style="left: 72px; top: 185px;" /><li style="left: 227px; top: 312px;" /><li style="left: 149px; top: 50px;" /><li style="left: 291px; top: 263px;" /><li style="left: 79px; top: 50px;" /><li style="left: 277px; top: 65px;" /><li style="left: 36px; top: 248px;" /><li style="left: 93px; top: 305px;" /><li style="left: 255px; top: 86px;" /><li style="left: 241px; top: 100px;" /><li style="left: 227px; top: 114px;" /><li style="left: 213px; top: 128px;" /><li style="left: 199px; top: 142px;" /><li style="left: 185px; top: 156px;" /><li style="left: 305px; top: 135px;" /></ul>
                    </div>
                    <div id="container" style="position: absolute; width: 100%; height: 100%; top: 0;"></div>
                    <div id="start" style="display: none; position: absolute; left: 50%; top: 50%; width: 64px; height: 30px; margin-left: -32px; margin-top: -16px; background-color: rgba(0,0,0,0.5); border: solid burlywood 1px;"><div style="height: 22px; margin: 5px; font-size: 14px; line-height: 22px; color: bisque; text-align: center;">开始</div></div>
                    <div id="ch" style="position: absolute;">
                        <div id="onoff" style="position: absolute; top: -16px; left: 50%; margin-left: -16px; width: 0; border: solid transparent 16px; border-top-width: 0; border-bottom-color: rgba(0,0,0,0.5);"></div>
                        <div style="float:left; background-color: rgba(0,0,0,0.5); width: 323px; height: 32px;">
                            <input style="width: 313px; height: 32px; border: 0; background-color: transparent; color: #fff; padding: 0 5px;">
                        </div>
                        <div class="s" style="float:left; width: 32px; height: 32px; font-size: 14px; line-height: 32px; text-align: center; color: #fff; background-color: green;"></div>
                    </div>
                </div>
                <div style="padding: 5px; background-color: burlywood; height: 22px;">
                    <div id="b"></div><div id="y" style="float: right;"></div><div style="clear: both;"></div>
                </div>
            </div>
            <div id="popup" style="display:none; position: absolute; top: 0; background-color: rgba(0,0,0,0.5); height: 100%; width: 100%; z-index: 18;">
                <div id="reset" style="position: absolute; width: 64px; height: 30px; background-color: burlywood; border: bisque solid 1px; left: 50%; top: 50%; margin-left: -32px; color: bisque;"><div style="height: 22px; margin: 5px; font-size: 14px; line-height: 22px; color: bisque; text-align: center;">重来</div></div>
            </div>
        </div>
        <div style="margin-top: 10px;">
            <div style="float:right;">©版权所有,转载请注明出处</div>
            <div style="clear:both;"></div>
        </div>
        <script type="text/javascript">
            var config = {
                murl: 'http://localhost/index.php',
                surl: 'ws://106.15.196.7:61614',
                path: [
                    '06,07,05,04,16,82,26,45,64,78,21,40,59,88,32,51,70,87,24,43,62,81,23,42,61,80,30,48,68,85,29,46,65,83,27,39,58,77,20,49,69,86,31,50,63,95,25,44,60,79,22,41,66,84,28,33,34,35,36,37,38',
                    '02,03,01,00,19,24,43,62,81,23,42,61,80,30,48,68,85,29,46,65,83,27,39,58,77,20,49,69,86,31,50,63,95,25,44,60,79,22,41,66,84,28,47,67,82,26,45,64,78,21,40,59,88,32,51,57,56,55,54,53,52',
                    '14,15,13,12,18,46,65,83,27,39,58,77,20,49,69,86,31,50,63,95,25,44,60,79,22,41,66,84,28,47,67,82,26,45,64,78,21,40,59,88,32,51,70,87,24,43,62,81,23,42,61,80,30,48,68,76,75,74,73,72,71',
                    '10,11,09,08,17,63,95,25,44,60,79,22,41,66,84,28,47,67,82,26,45,64,78,21,40,59,88,32,51,70,87,24,43,62,81,23,42,61,80,30,48,68,85,29,46,65,83,27,39,58,77,20,49,69,86,89,90,91,92,93,94'
                ]
            };
            
            /**
             * global = {
             *     d: [
             *         {
             *             name: '00001',
             *             data: [-1, 2, 3, 4] // 位置
             *         },
             *         null,
             *         null,
             *         null
             *     ],
             *     c: 'r', // 颜色
             *     t: 'AC032220FD4F962803A24713911D532D', // 令牌
             *     s: { // 开始
             *         p: 'r',
             *         i: false, // 投掷,出棋
             *     },
             *     o: true  // 房主,成员
             * };
             *
             */
            var global;
            var events = { e: [] };
            var server;

            function Server(m) {
                var s = function () {
                    var c = Stomp.client(config.surl);
                    c.debug = function (d) {};
                    c.connect('guest', 'guest', function (f) {
                        if (server.c) {
                            server.init(server.m);
                        }
                        server.c = c;
                        c.subscribe('/topic/' + server.m.i, function (m) {
                            server.recv(JSON.parse(m.body));
                        });
                    }, function () {
                        server.recv({ type: 'h', d: '<span style="color: red;">[消息]</span>连接中...' });
                        setTimeout(s, 2000);
                    });
                };
                this.init(this.m = m, s);
            };

            Server.prototype.init = function (m, success) {
                this.send(m, function (responseData) {
                    if (responseData) {
                        global = responseData;
                        $('#token').hide();
                        $('#popup').hide();
                        $('#m').show();
                        $('#q').empty();
                        $('#room li').empty();
                        $('#bg').attr('class', global.c);
                        $('#craps').hide();
                        $('#start').hide();
                        if (global.s) {
                            if (global.s.i) {
                                showCraps();
                            }
                        } else if (global.o) {
                            $('#start').show();
                        }
                        $('#container').empty();
                        for (var i = 0; i < global.d.length; i++) {
                            if (global.d[i]) {
                                for (var j = 0; j < global.d[i].data.length; j++) {
                                    var offset =  $('#cords li').eq(parseInt(config.path[i].split(',')[[global.d[i].data[j] < 0 ? j : global.d[i].data[j]]])).offset();
                                    var o = $('<div class="' + 'ybgrybgr'.substr('ybgrybgr'.indexOf(global.c), 4)[i] + (global.d[i].data[j] < 0 ? 1 : 0) + '" style="position: absolute;" data-i="' + i + ',' + j + '"></div>');
                                    $('#container').append(o);
                                    o.offset({ left: offset.left - 3, top: offset.top - 3 });
                                    o.on('click', function (e) {
                                        e.preventDefault();
                                        if (!events.s && global.s.p == global.c) {
                                            var i = $(this).data('i').split(',');
                                            i[0] = parseInt(i[0]), i[1] = parseInt(i[1]);
                                            if (!i[0] && global.d[0].data[i[1]] != -1) {
                                                server.send({ type: 'm', i: i[1] });
                                            }
                                        }
                                    });
                                }
                            }
                            $('#' + 'ybgr'[i]).text(global.d[i] ? global.d[i].name : '');
                        }
                        rearrange();
                        if (success) {
                            success();
                        }
                    }
                });
            }

            Server.prototype.send = function (m, success) {
                var data = { m: m };
                if (global && global.t) {
                    data.t = global.t;
                }
                $.ajax({ url: config.murl, method: 'GET', data: { d: JSON.stringify(data) }, complete: function (XHR, TS) {
                    if (TS == 'success' && success) {
                        var responseData;
                        if (XHR.responseText) {
                            responseData = JSON.parse(XHR.responseText);
                        }
                        success(responseData);
                    }
                }});
            };
            
            Server.prototype.recv = function (m) {
                if (m.type == 'c') {
                    global.s = { p: m.p, i: true };
                    $('#start').hide();
                    if (m.i != undefined) {
                        events.e.push(function (finish) {
                            craps(m.i, finish);
                        });
                    } else if (global.s.p == global.c) {
                        events.e.push(function (finish) {
                            showCraps();
                            finish();
                        });
                    }
                    handleEvent();
                } else if (m.type == 'm') {
                    events.e.push(function (finish) {
                        moveTo(m.i, m.c, m.t, finish);
                    });
                    handleEvent();
                } else if (m.type == 'e') {
                    this.init(this.m);
                } else if (m.type == 'r') {
                    if (m.t) {
                        this.recv({
                            type: 'h',
                            d: '<span style="color: red;">[消息]</span>' + global.d['ybgrybgr'.substr('ybgrybgr'.indexOf(global.c), 4).indexOf(m.t)].name + '胜出!'
                        });
                    }
                    $('#popup').show();
                } else if (m.type == 'h') {
                    $('#q').html(m.d);
                    if ($('#q').data('h')) {
                        clearTimeout($('#q').data('h'));
                    }
                    $('#q').data('h', setTimeout(function () { $('#q').empty(), $('#q').data('h', ''); }, 2000));
                }
            };

            function handleEvent() {
                if (events.s) {
                    return ;
                }
                if (events.e.length) {
                    events.s = 'aha';
                    events.e.shift()(function () {
                        events.s = false;
                        handleEvent();
                    });
                }
            }

            function values(i) {
                i = i.split(',');
                i[0] = parseInt(i[0]), i[1] = parseInt(i[1]);
                return parseInt(config.path[i[0]].split(',')[global.d[i[0]].data[i[1]] < 0 ? i[1] : global.d[i[0]].data[i[1]]]);
            }

            function rearrange() {
                var o = $('#container div');
                o.css('z-index', '');
                o.sort(function (a, b) {
                    return values($(a).data('i')) < values($(b).data('i'));
                });
                var i = 0;
                for (; i < o.length; i++) {
                    var a = values($(o[i]).data('i'));
                    var offset = $('#cords li').eq(a).offset();
                    $(o[i]).offset({ left: offset.left - 3, top: offset.top - 3 });
                    $(o[i]).css('z-index', 0);
                    {
                        var j = i + 1;
                        for (; j < o.length; j++) {
                            if (a == values($(o[j]).data('i'))) {
                                $(o[j]).offset({ left: offset.left - 3, top: offset.top - 3 - 4 * (j - i) });
                                $(o[j]).css('z-index', j - i);
                            } else {
                                break;
                            }
                        }
                        i = j - 1;
                    }
                }
            }

            function showCraps() {
                if ($('#craps').data('h')) {
                    clearInterval($('#craps').data('h'));
                    $('#craps').data('h', '');
                }
                $('#craps').attr('class', 'ybgr'['ybgrybgr'.substr('ybgrybgr'.indexOf(global.c), 4).indexOf(global.s.p)]);
                $('#craps').show();
            }

            function craps(i, finish) {
                showCraps();
                $('#craps').attr('data-i', i);
                $('#craps').data('i', 0);
                $('#craps').data('h', setInterval(function () {
                    var i = $('#craps').data('i');
                    if (i < 7) {
                        $('#craps').css('background-position-x', -i * 60 + 'px'), $('#craps').data('i', ++i);
                        return ;
                    }
                    setTimeout(function () {
                        $('#craps').hide();
                        if (finish) {
                            finish();
                        }
                    }, 1000);
                    clearInterval($('#craps').data('h'));
                    $('#craps').data('h', '');
                }, 32));
            }

            function moveTo(i, c, t, finish) {
                var m = function(e, s) {
                    var offset =  $('#cords li').eq(parseInt(config.path[i[0]].split(',')[s < 0 ? i[1] : s])).offset();
                    $('#container div[data-i="' + i + '"]').animate({ left: offset.left - $('#content').offset().left - 3, top: offset.top - $('#content').offset().top - 3 }, 'fast', 'swing', function () {
                        if (s == t || s < 0) {
                            e.data('h', '');
                            e.attr('class', e.attr('class').substr(0, 1) + (s < 0 ? 1 : 0));
                            rearrange();
                            if (finish) {
                                finish();
                            }
                            return ;
                        }
                        m(e, s < t ? s + 1 : s - 1);
                    });
                };
                i = i.split(',');
                i[0] = 'ybgrybgr'.substr('ybgrybgr'.indexOf(global.c), 4).indexOf(i[0]), i[1] = parseInt(i[1]);
                {
                    var e = $('#container div[data-i="' + i.join(',') + '"]');
                    if (e.data('h')) {
                        return ;
                    }
                    e.css('z-index', 16);
                    m(e, c ? t : (global.d[i[0]].data[i[1]] < 4 ? 4 : global.d[i[0]].data[i[1]] < t ? global.d[i[0]].data[i[1]] + 1 : global.d[i[0]].data[i[1]] - 1));
                    e.data('h', 1);
                    global.d[i[0]].data[i[1]] = t;
                }
            }

            function load() {
                var r = window.location.href.match(new RegExp('#\/i\/[0-9]{4}$'));
                if (r) {
                    server = new Server({ type: 'e', i: r[0].substr(4) });
                    return 'aha';
                }
            }

            $(function () {
                load();
                $('#keyboard li').on('click', function (e) {
                    e.preventDefault();
                    var t = $(this).text();
                    if (t == '<') {
                        var p;
                        $('#room li').each(function (i, e) {
                            if (!$(this).text()) {
                                p = i;
                                return false;
                            }
                        });
                        if (p) {
                            $('#room li').eq(p - 1).empty();
                        } else if (p == undefined) {
                            $('#room li').last().empty();
                        }
                        return ;
                    }
                    $('#room li').each(function (i, e) {
                        if (!$(this).text()) {
                            $(this).text(t);
                            if ($('#room li').length - 1 == i) {
                                t = '';
                                $('#room li').each(function (i, e) {
                                    t += $(this).text();
                                });
                                window.location.href = '#/i/' + t;
                                load();
                            }
                            return false;
                        }
                    });
                });
                $('#start').on('click', function (e) {
                    e.preventDefault();
                    server.send({ type: 's' });
                });
                $('#reset').on('click', function (e) {
                    e.preventDefault();
                    server.init(server.m);
                });
                $('#leave').on('click', function (e) {
                    e.preventDefault();
                    if (server.c) {
                        for(var i in server.c.subscriptions) {
                            server.c.unsubscribe(i);
                        }
                    }
                    server.send({ type: 'q' }, function () {
                        if (server.c) {
                            server.c.disconnect();
                        }
                        $('#token').show(), $('#m').hide(), window.location.href = '#';
                    });
                });
                $('#craps').on('click', function (e) {
                    e.preventDefault();
                    if (global.s.i && global.s.p == global.c && !events.s) {
                        server.send({ type: 'c' });
                        if ($('#craps').data('h')) {
                            return ;
                        }
                        $('#craps').data('i', 0);
                        $('#craps').data('h', setInterval(function () {
                            var i = $('#craps').data('i');
                            $('#craps').css('background-position-x', -(i % 7) * 60 + 'px');
                            $('#craps').data('i', i + 1);
                        }, 32));
                    }
                });
                $('#onoff').on('click', function (e) {
                    e.preventDefault();
                    $('#ch').toggleClass('on');
                });
                $('#ch .s').on('click', function (e) {
                    e.preventDefault();
                    var d = $('#ch input').val();
                    if (d) {
                        server.send({ type: 'h', d: d }, function () {$('#ch input').val('');});
                    }
                });
            });
        </script>
    </div>
</body>
</html>